{% extends 'sells/base.html' %}
{% load static %}
{% block title %}{{ client.name }} - 客户详情{% endblock %}
{% block page_title %}{{ client.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'client_list' %}">客户列表</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ client.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            {% if request.user.user_type == 'admin' %}
            <a href="{% url 'client_update' client.pk %}" class="btn btn-secondary btn-sm">
                <i class="bi bi-pencil"></i> 编辑
            </a>
            {% endif %}
            <a href="{% url 'client_list' %}?page={{ page }}" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-left"></i> 返回
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- 基本信息 -->
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">基本信息</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">联系人</span>
                        <span>{{ client.contact_person }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">联系电话</span>
                        <span>{{ client.phone }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">电子邮箱</span>
                        <span>{{ client.email }}</span>
                    </li>
                    <li class="list-group-item">
                        <span class="text-muted">地址</span>
                        <p class="mt-2">{{ client.address }}</p>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">行业</span>
                        <span>{{ client.get_industry_display }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">负责销售</span>
                        <span>{{ client.assigned_salesperson|default:"未分配" }}</span>
                    </li>
                </ul>
            </div>
        </div>
        <!-- 联系人信息 -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">额外联系人信息</h5>
                <a href="{% url 'add_contact' client.pk %}" class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if contacts %}
                <div class="list-group">
                    {% for contact in contacts %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <h6>{{ contact.name }}</h6>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'update_contact' contact.pk %}" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i> 编辑
                                </a>
                                <button class="btn btn-outline-danger delete-btn"
                                        data-model="contact"
                                        data-id="{{ contact.pk }}"
                                        data-name="{{ contact.name }}">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
{#                            <span class="badge bg-{% if contact.condition == 'good' %}success{% elif contact.condition == 'fair' %}warning{% else %}danger{% endif %}">#}
{#                                {{ contact.get_condition_display }}#}
{#                            </span>#}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small>联系电话: {{ contact.phone }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无联系人信息</p>
                {% endif %}
            </div>
        </div>
        <!-- 设备信息 -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">设备信息</h5>
                <a href="{% url 'add_equipment' client.pk %}" class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if equipments %}
                <div class="list-group">
                    {% for equipment in equipments %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <h6>{{ equipment.model }}</h6>
                            <span class="badge bg-{% if equipment.condition == 'good' %}success{% elif equipment.condition == 'fair' %}warning{% else %}danger{% endif %}">
                                {{ equipment.get_condition_display }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small>使用年限: {{ equipment.years_in_use }}年</small>
                            <small>编号: {{ equipment.equipment_id }}</small>
                        </div>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'update_equipment' equipment.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> 编辑
                        </a>
                        <button class="btn btn-outline-danger delete-btn"
                                data-model="equipment"
                                data-id="{{ equipment.pk }}"
                                data-name="{{ equipment.model }}">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无设备信息</p>
                {% endif %}
            </div>
        </div>
        <!-- 所做产品信息 -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">所做产品信息</h5>
                <a href="{% url 'add_generation' client.pk %}" class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if generations %}
                <div class="list-group">
                    {% for generation in generations %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <h6>{{ generation.name }}</h6>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'update_generation' generation.pk %}" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i> 编辑
                                </a>
                                <button class="btn btn-outline-danger delete-btn"
                                        data-model="generation"
                                        data-id="{{ generation.pk }}"
                                        data-name="{{ generation.name }}">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
{#                            <span class="badge bg-{% if generation.condition == 'good' %}success{% elif generation.condition == 'fair' %}warning{% else %}danger{% endif %}">#}
{#                                {{ generation.get_condition_display }}#}
{#                            </span>#}
                        </div>
{#                        <div class="d-flex justify-content-between mt-2">#}
{#                            <small>: {{ generation.name }}</small>#}
{#                        </div>#}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无所做产品信息</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="col-md-8">
        <!-- 拜访记录 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">拜访记录</h5>
                <a href="{% url 'visit_create' %}?client_id={{ client.pk }}"
                   class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> 新建拜访
                </a>
            </div>
            <div class="card-body">
                {% if visits %}
                <div class="list-group">
                    {% for visit in visits %}
                    <a href="{% url 'visit_detail' visit.pk %}"
                       class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">{{ visit.get_purpose_display }}</h6>
                            <small class="text-muted">{{ visit.visit_date }}</small>
                        </div>
                        <p class="mb-1 text-truncate">{{ visit.next_steps }}</p>
                        <small class="text-muted">负责人: {{ visit.salesperson.username }}</small>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-journal-x fs-1"></i>
                    <p class="mt-3">暂无拜访记录</p>
                    <a href="{% url 'visit_create' %}?client_id={{ client.pk }}"
                       class="btn btn-primary mt-2">
                        <i class="bi bi-plus-circle"></i> 添加拜访记录
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 竞争对手 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">竞争对手</h5>
                <a href="{% url 'add_competitor' client.pk %}"
                   class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if competitors %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>产品优势</th>
                                <th>对比分析</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for competitor in competitors %}
                            <tr>
                                <td>{{ competitor.name }}</td>
                                <td>{{ competitor.advantages|truncatechars:30 }}</td>
                                <td>{{ competitor.comparison|truncatechars:30 }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'update_competitor' competitor.pk %}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil">编辑</i>
                                        </a>
                                        <button class="btn btn-outline-danger delete-btn"
                                                data-model="competitor"
                                                data-id="{{ competitor.pk }}"
                                                data-name="{{ competitor.name }}">
                                            <i class="bi bi-trash">删除</i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无竞争对手信息</p>
                {% endif %}
            </div>
        </div>
        <!-- 购买记录 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">购买记录</h5>
                <a href="{% url 'add_purchase' client.pk %}"
                   class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if purchases %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>产品数量</th>
                                <th>购买时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for purchase in purchases %}
                            <tr>
                                <td>{{ purchase.name }}</td>
                                <td>{{ purchase.count }}</td>
                                <td>{{ purchase.purchase_date | date:'Y-m-d' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'update_purchase' purchase.pk %}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil">编辑</i>
                                        </a>
                                        <button class="btn btn-outline-danger delete-btn"
                                                data-model="purchase"
                                                data-id="{{ purchase.pk }}"
                                                data-name="{{ purchase.name }}">
                                            <i class="bi bi-trash">删除</i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无购买记录信息</p>
                {% endif %}
            </div>
        </div>
        <!-- 报价记录 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">报价</h5>
                <a href="{% url 'add_quotation' client.pk %}"
                   class="btn btn-sm btn-warning">
                    <i class="bi bi-plus"></i> 添加
                </a>
            </div>
            <div class="card-body">
                {% if quotations %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>单价</th>
                                <th>报价时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for quotation in quotations %}
                            <tr>
                                <td>{{ quotation.name }}</td>
                                <td>{{ quotation.count }}</td>
                                <td>{{ quotation.quotation_date | date:'Y-m-d' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'update_quotation' quotation.pk %}" class="btn btn-outline-primary">
                                            <i class="bi bi-pencil">编辑</i>
                                        </a>
                                        <button class="btn btn-outline-danger delete-btn"
                                                data-model="quotation"
                                                data-id="{{ quotation.pk }}"
                                                data-name="{{ quotation.name }}">
                                            <i class="bi bi-trash">删除</i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                </div>
                {% else %}
                <p class="text-center text-muted py-3">暂无报价信息</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script src="{% static 'app01/js/jquery-3.6.0.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 删除按钮点击事件处理
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const model = this.getAttribute('data-model');
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');

            if (confirm(`确定要删除 "${name}" 吗？此操作不可撤销！`)) {
                // 显示加载状态
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> 删除中...';
                this.disabled = true;

                // 发送AJAX删除请求
                fetch(`/delete-${model}/${id}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    {#contentType: "application/json",#}
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 删除成功，刷新页面
                        location.reload();
                    } else {
                        alert('删除失败: ' + (data.message || '未知错误'));
                        this.innerHTML = originalHtml;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除过程中发生错误');
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                });
            }
        });
    });
});
</script>
<style>
    .card-header{
        background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
        border-bottom: none;
        padding: 1.5rem;
        color: white;
    }
</style>
{% endblock %}