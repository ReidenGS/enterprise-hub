{% extends 'sells/base.html' %}

{% block title %}拜访详情 - {{ visit.client.name }}{% endblock %}
{% block page_title %}拜访详情 - {{ visit.client.name }} ({{ visit.visit_date|date:"Y年m月d日" }}){% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'visit_list' %}">拜访记录列表</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ visit.client.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <a href="{% url 'visit_list' %}?page={{ page }}" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-left"></i> 返回
            </a>
        </div>
    </div>
</div>
{% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<style>
    .visit-download{
        color: greenyellow;
    }
</style>


<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0"><i class="bi bi-journal-check me-2"></i> 拜访基本信息</h5>
                <a class='visit-download' href="{% url 'download_visit_record' record_id=visit.record_id %}">下载客户拜访记录文档</a>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-3">客户名称:</dt>
                    <dd class="col-sm-9 fw-bold"><a href="{% url 'client_detail' visit.client.pk %}" class="text-white text-decoration-none bg-primary rounded-pill px-3 py-1">{{ visit.client.name }}</a></dd>

                    <dt class="col-sm-3">拜访日期:</dt>
                    <dd class="col-sm-9">{{ visit.visit_date|date:"Y年m月d日" }}</dd>

                    <dt class="col-sm-3">拜访目的:</dt>
                    <dd class="col-sm-9">{{ visit.get_purpose_display }}</dd>

                    <dt class="col-sm-3">地点:</dt>
                    <dd class="col-sm-9">{{ visit.location|default:"N/A" }}</dd>

                    <dt class="col-sm-3">负责人:</dt>
                    <dd class="col-sm-9">{{ visit.salesperson.username }}</dd>

                    <dt class="col-sm-3">描述:</dt>
                    <dd class="col-sm-9">{{ visit.description|default:"无" }}</dd>

                    <dt class="col-sm-3">创建日期:</dt>
                    <dd class="col-sm-9">{{ visit.created_at|date:"Y年m月d日 H:i" }}</dd>
                </dl>
            </div>
            <div class="card-footer text-end bg-light">
                <a href="{% url 'visit_record_detail' visit.pk %}?page={{ page }}" class="btn btn-primary btn-sm me-2">
                    <i class="bi bi-pencil me-1"></i> 查看详情
                </a>
                <a href="{% url 'visit_update' visit.pk %}" class="btn btn-warning btn-sm me-2">
                    <i class="bi bi-pencil me-1"></i> 编辑拜访
                </a>
                <a href="{% url 'visit_delete' visit.pk %}" class="btn btn-danger btn-sm me-2">
                    <i class="bi bi-pencil me-1"></i> 删除记录
                </a>
                <a href="{% url 'add_followup' visit.pk %}" class="btn btn-success btn-sm">
                    <i class="bi bi-plus-circle me-1"></i> 添加跟进计划
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white py-3">
                <h5 class="mb-0"><i class="bi bi-bell-fill me-2"></i>跟进计划</h5>
            </div>
            <div class="card-body p-0">
                {% if followups %}
                <div class="list-group list-group-flush">
                    {% for followup in followups %}
                    <div class="list-group-item py-3 px-4">
                        <div class="d-flex w-100 justify-content-between mb-1">
                            <h6 class="mb-0 fw-bold">{{ followup.expected_outcome|default:"无预期成果" }}</h6>
                            <small class="text-muted">{{ followup.follow_up_date|date:"Y年m月d日" }}</small>
                        </div>
                        <p class="mb-1 text-truncate text-muted">{{ followup.notes|default:"无备注" }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-secondary">负责人: {{ followup.responsible_person.username }}</small>
                            <span class="badge bg-{% if followup.is_completed %}success{% else %}warning text-dark{% endif %} rounded-pill px-3 py-1">
                                {% if followup.is_completed %}已完成{% else %}待处理{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-calendar-check display-5 mb-3"></i>
                    <p class="fs-5">暂无跟进计划</p>
                    <p class="text-muted">为本次拜访添加跟进计划。</p>
                    <a href="{% url 'add_followup' visit.pk %}" class="btn btn-primary btn-sm mt-3">添加跟进计划</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}