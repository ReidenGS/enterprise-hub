{% extends 'sells/base.html' %}

{% block title %}拜访记录详情 - {{ record.client.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card border-0 shadow-lg">
        <!-- 卡片头部 -->
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0"><i class="fas fa-calendar-check mr-2"></i>拜访记录详情</h3>
                <small class="opacity-80">记录ID: {{ record.record_id }}</small>
            </div>
            <a href="{% url 'visit_detail' record.pk %}?page={{ page }}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left mr-1"></i> 返回
            </a>
        </div>

        <div class="card-body">
            <!-- 基本信息 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="info-card">
                        <h5 class="info-card-title"><i class="fas fa-info-circle mr-2"></i>基本信息</h5>
                        <div class="info-card-body">
                            <div class="info-item">
                                <span class="info-label">客户名称:</span>
                                <span class="info-value">{{ record.client.name }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">销售人员:</span>
                                <span class="info-value">{{ record.salesperson.get_full_name }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">拜访日期:</span>
                                <span class="info-value">{{ record.visit_date }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">拜访目的:</span>
                                <span class="info-value">{{ purpose_display }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">拜访方式:</span>
                                <span class="info-value">
                                    {{ method_display }}
                                    {% if record.custom_method %}({{ record.custom_method }}){% endif %}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">拜访时长:</span>
                                <span class="info-value">
                                    预计: <span class="text-primary">{{ record.planned_duration|default:"-" }}</span>小时 /
                                    实际: <span class="text-primary">{{ record.actual_duration|default:"-" }}</span>小时
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="info-card">
                        <h5 class="info-card-title"><i class="fas fa-handshake mr-2"></i>合作意向</h5>
                        <div class="info-card-body">
                            <div class="cooperation-progress mb-3">
                                <div class="progress-label d-flex justify-content-between mb-1">
                                    <span>合作意向度</span>
                                    <span class="font-weight-bold">{{ intention_display }}</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar
                                        {% if record.cooperation_intention == 'high' %}bg-success
                                        {% elif record.cooperation_intention == 'medium' %}bg-warning
                                        {% elif record.cooperation_intention == 'low' %}bg-danger
                                        {% else %}bg-secondary{% endif %}"
                                        role="progressbar"
                                        style="width:
                                            {% if record.cooperation_intention == 'high' %}100%
                                            {% elif record.cooperation_intention == 'medium' %}65%
                                            {% elif record.cooperation_intention == 'low' %}30%
                                            {% else %}0%{% endif %}"
                                        aria-valuenow="100"
                                        aria-valuemin="0"
                                        aria-valuemax="100">
                                    </div>
                                </div>
                            </div>

                            <div class="purchase-plan mt-4">
                                <h6 class="section-subtitle"><i class="fas fa-shopping-cart mr-2"></i>采购计划</h6>
                                <div class="purchase-badge">
                                    {% if record.has_purchase_plan %}
                                        <span class="badge badge-success badge-pill">
                                            <i class="fas fa-check-circle mr-1"></i>有采购计划
                                        </span>
                                        <div class="purchase-time mt-2">
                                            <i class="far fa-calendar-alt mr-2"></i>
                                            预计时间: <strong>{{ record.purchase_time|default:"未确定" }}</strong>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-secondary badge-pill">
                                            <i class="fas fa-times-circle mr-1"></i>暂无采购计划
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 客户需求与反馈 -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="section-header"><i class="fas fa-comments mr-2"></i>客户需求与反馈</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-card">
                                <div class="detail-card-header">
                                    <i class="fas fa-tools mr-2"></i>需求设备
                                </div>
                                <div class="detail-card-body">
                                    {{ record.required_equipment|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                                </div>
                            </div>

                            <div class="detail-card">
                                <div class="detail-card-header">
                                    <i class="fas fa-star mr-2"></i>特殊需求
                                </div>
                                <div class="detail-card-body">
                                    {{ record.special_requirements|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="detail-card">
                                <div class="detail-card-header">
                                    <i class="fas fa-thumbs-up mr-2"></i>产品反馈
                                </div>
                                <div class="detail-card-body">
                                    {{ record.feedback_on_products|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                                </div>
                            </div>

                            <div class="detail-card">
                                <div class="detail-card-header">
                                    <i class="fas fa-users mr-2"></i>竞争对手情况
                                </div>
                                <div class="detail-card-body">
                                    {{ record.competitor_satisfaction|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 销售进展 -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="section-header"><i class="fas fa-chart-line mr-2"></i>销售进展</h4>
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-bullhorn mr-2"></i>重点介绍产品
                        </div>
                        <div class="detail-card-body">
                            {{ record.featured_products|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-lightbulb mr-2"></i>提供的解决方案
                        </div>
                        <div class="detail-card-body">
                            {{ record.solutions_provided|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-arrow-right mr-2"></i>下一步行动
                        </div>
                        <div class="detail-card-body">
                            {{ record.next_steps|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 问题与建议 -->
            <div class="row">
                <div class="col-12">
                    <h4 class="section-header"><i class="fas fa-exclamation-circle mr-2"></i>问题与建议</h4>
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-exclamation-triangle mr-2"></i>遇到的问题
                        </div>
                        <div class="detail-card-body">
                            {{ record.issues_encountered|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-hands-helping mr-2"></i>解决建议
                        </div>
                        <div class="detail-card-body">
                            {{ record.proposed_solutions|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>

                    <div class="detail-card">
                        <div class="detail-card-header">
                            <i class="fas fa-ellipsis-h mr-2"></i>其他信息
                        </div>
                        <div class="detail-card-body">
                            {{ record.other_message|default:"<span class='text-muted'>无记录</span>"|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
            <small class="text-muted">
                <i class="far fa-clock mr-1"></i>记录创建于 {{ record.created_at }}
                {% if record.updated_at != record.created_at %}
                    | 最后更新于 {{ record.updated_at }}
                {% endif %}
            </small>
            <a href="{% url 'visit_detail' record.pk %}?page={{ page }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left mr-1"></i> 返回
            </a>
        </div>
    </div>
</div>

<style>
    /* 主卡片样式 */
    .card {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    /* 渐变背景 */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    }

    /* 信息卡片样式 */
    .info-card {
        background: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        height: 100%;
    }

    .info-card-title {
        padding: 1rem 1.25rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        border-radius: 0.5rem 0.5rem 0 0;
        font-size: 1.1rem;
        color: #495057;
    }

    .info-card-body {
        padding: 1.25rem;
    }

    .info-item {
        display: flex;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px dashed #e9ecef;
    }

    .info-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .info-label {
        flex: 0 0 30%;
        font-weight: 600;
        color: #6c757d;
    }

    .info-value {
        flex: 1;
        color: #495057;
    }

    /* 详情卡片样式 */
    .detail-card {
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .detail-card:last-child {
        margin-bottom: 0;
    }

    .detail-card-header {
        padding: 0.75rem 1.25rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        color: #495057;
    }

    .detail-card-body {
        padding: 1.25rem;
        background: #fff;
    }

    /* 进度条样式 */
    .cooperation-progress {
        margin-bottom: 1.5rem;
    }

    .progress-label {
        font-size: 0.875rem;
    }

    .progress {
        height: 0.5rem;
        border-radius: 0.25rem;
    }

    /* 采购计划样式 */
    .purchase-plan {
        margin-top: 1.5rem;
    }

    .purchase-badge {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .purchase-time {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* 分区标题样式 */
    .section-header {
        position: relative;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .section-header::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -2px;
        width: 100px;
        height: 2px;
        background: #3a7bd5;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .info-item {
            flex-direction: column;
        }

        .info-label {
            margin-bottom: 0.25rem;
        }
    }
</style>

{% endblock %}