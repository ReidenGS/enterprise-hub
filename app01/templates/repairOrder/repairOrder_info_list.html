{% extends 'repairOrder/layout.html' %}
{% load static %}
{% block content %}
<div class="container-fluid" style="background-color: #f8f9fa; padding: 10px 0; margin-bottom: 20px;">
    <div class="container">
        <form id="searchForm" method="get" action="/repairOrder_info/?token={{ token }}">
            <input type="hidden" name="token" value="{{ token }}">
            <div class="row">
                <!-- 紧急程度筛选 -->
                <div class="col-md-1">
                    <select class="form-control" name="emergency_level">
                        <option value="">全部紧急程度</option>
                        <option value="low">一般</option>
                        <option value="medium">紧急</option>
                        <option value="high">加急</option>
                    </select>
                </div>

                <!-- 订单状态筛选 -->
                <div class="col-md-2">
                    <select class="form-control" name="status">
                        <option value="">全部状态</option>
                        <option value="0">待受理</option>
                        <option value="1">待处理</option>
                        <option value="2">处理中</option>
                        <option value="3">已完成</option>
                    </select>
                </div>

                <!-- 关键词搜索 -->
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="企业/报修单号/机器编号/负责工作人员/负责人">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" onclick="submitSearch()">
                                <i class="glyphicon glyphicon-search"></i>
                            </button>
                        </span>
                    </div>
                </div>

                <!-- 日期范围 -->
                <div class="col-md-3">
                    <div class="input-daterange input-group" id="datepicker">
                        <input type="text" class="form-control" name="start_date" placeholder="开始日期">
                        <span class="input-group-addon">至</span>
                        <input type="text" class="form-control" name="end_date" placeholder="结束日期">
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">筛选</button>
                    <button type="button" class="btn btn-default" onclick="resetSearch()">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
    <!--面板图表-->
    <div class="panel panel-default" style="margin-top: 20px;">
        <!-- Default panel contents -->

        <table class="table table-striped table-bordered table-hover" >
            <thead>
            <tr>
                <th>编号</th>
                <th>报修单编号</th>
                <th>报修企业</th>
                <th>负责人</th>
                <th>联系电话</th>
                <th>紧急程度</th>
                <th>维修机型</th>
                <th>维修状态</th>
                <th style="text-align: center">操作</th>
            </tr>
            </thead>
            <tbody>
            {% for obj in queryset %}
                <tr>
                    <td>{{ obj.id }}</td>
                    <td>{{ obj.order_id}}</td>
                    <td>{{obj.customer_name}}</td>
                    <td>{{obj.responsible_name}}</td>
                    <td>{{obj.customer_phone}}</td>
                    <td>{{obj.emergency_level}}</td>
                    <td>{{obj.machine_model}}</td>
                    <td>{{obj.status}}</td>
{#                    <td>{{ obj.machine}}</td>#}
                    <td class="fried">
                        <a class="btn btn-primary btn-xs" href="/repair_info/{{ obj.id }}/detail/?{{ params }}">查看详情</a>
                        {% if obj.quotation_status == '未报价' %}
                            <a class="btn btn-warning btn-xs" href="/repair_info/{{ obj.id }}/quotation/?{{params}}">报价</a>
                            {% else %}
                            <a class="btn btn-warning btn-xs" href="/repair_info/{{ obj.id }}/quotation/?{{params}}">查看报价</a>
                            {% endif %}
                        {% if obj.dispatch_status == '未派遣' %}
                            <a class="btn btn-danger btn-xs" href="/repair_info/{{ obj.id }}/add_worker/?{{params}}">派遣员工</a>
                            {% else %}
                            <a class="btn btn-danger btn-xs" href="/repair_info/{{ obj.id }}/add_worker/?{{params}}">更换派遣员工</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <ul class="pagination">
        {{ page_string }}
        <li>
            <form style="float: left;margin-left: -1px" method="post">
                <input name="page"
                       style="position: relative;float:left;display: inline-block;width: 80px;border-radius: 0;"
                       type="text" class="form-control" placeholder="页码" id="page">
                <button style="border-radius: 0" class="btn btn-default" onclick="submitPage()">跳转</button>
            </form>
        </li>
    </ul>

{% endblock %}
{% block js %}
<script>
    function submitPage(page){
        url = new URL(window.location.href)
        $.ajax({
            url: url, // 后端API端点
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
             },
            data: JSON.stringify({
                page : $('#page')
            }),
            success: function(response) {
                console.log('ok')
            },
            error: function(xhr, status, error) {
                {#$('#addMachineModal').modal('hide');#}
            }
        });
    }
     // 日期选择器初始化
    $(function() {
        $('.input-daterange').datepicker({
            format: 'yyyy-mm-dd',
            startDate: '2025-01-01',
            language: "zh-CN",
            autoclose: true
        });

        // 从URL参数恢复筛选状态
        const urlParams = new URLSearchParams(window.location.search);
        $('[name="emergency_level"]').val(urlParams.get('emergency_level') || '');
        $('[name="status"]').val(urlParams.get('status') || '');
        $('[name="search"]').val(urlParams.get('search') || '');
        $('[name="start_date"]').val(urlParams.get('start_date') || '');
        $('[name="end_date"]').val(urlParams.get('end_date') || '');
    });

    function submitSearch() {
        $('#searchForm').submit();
    }

    function resetSearch() {
        $('select').val('');
        $('input[type="text"]').val('');
        $('#searchForm').submit();
    }
</script>
{% endblock %}