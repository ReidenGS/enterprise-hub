{% extends 'repairOrder/layout.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>添加负责工作人员</title>
    <link rel="stylesheet" href="{% static 'app01/plugins/bootstrap-3.4.1/css/bootstrap.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{%  static 'app01/plugins/bootstrap-datepicker/css/bootstrap-datepicker.css' %}">
    {% block css %}
    <style>
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .card-header {
            background-color: #4a76a8;
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 10px 20px;
        }
        .worker-card {
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            padding: 15px 20px;
        }
        .worker-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
         }
        .worker-card.selected {
            border: 0.5px  #4a76a8;
            background-color: #f0f7ff;
        }
        .btn-container {
            margin-top: 20px;
            text-align: center;
        }.input-daterange {
            width: 100%;
        }
         .input-daterange {
            width: 100%;
        }

    </style>
    {% endblock %}
</head>
{% block content %}
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-user-plus mr-2"></i>为报修单选择负责工作人员
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="workerForm" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="token" value="{{ token }}">
                            <div class="form-group">
                                <label class="font-weight-bold">可选工作人员：</label>
                                <div class="row" id="workerList">
                                    {% for worker in workers %}
                                    <div class="col-md-6">
                                        <div class="card worker-card p-3
                                            {% if worker.id == workerID %}selected{% endif %}"
                                             data-worker-id="{{ worker.id }}"

                                             onclick="selectWorker(this)">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h5>{{ worker.name }}</h5>
                                                    <p class="mb-1">
                                                        <i class="fas fa-id-card mr-2"></i>工号: {{ worker.employee_id }}
                                                    </p>
                                                    <p class="mb-1">
                                                        <i class="fas fa-phone mr-2"></i>电话: {{ worker.Tele}}
                                                    </p>
                                                </div>
                                                <div class="align-self-center">
                                                    <i class="fas fa-check-circle fa-2x text-muted  {% if worker.id == workerID %}text-success{% else %}text-muted{% endif %}"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="selectedWorkerId" name="worker_id">
                            </div>
                        <div class="card-body">
                            <form id = "repairDate" method="post">
                                <label>请设置报修时间</label>
                                <div class="input-daterange input-group" id="datepicker">
                                    <input type="text" class="form-control" name="start_date" placeholder="开始日期" id = "repair_date">
                                </div>
{#                            </form>#}
                        </div>
                            <div class="btn-container">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="fas fa-save mr-1"></i>确认选择
                                </button>
                                <a href="/repairOrder_info/?{{params}}" class="btn btn-info btn-lg">
                                    <i class="fas fa-arrow-left mr-1"></i>返回
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
    {% block js %}
    <script src="{% static 'app01/js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'app01/plugins/bootstrap-3.4.1/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'app01/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js' %}"></script>
    <script src="{% static 'app01/plugins/bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN.min.js' %}"></script>
    <script>
        $(function() {
        $('.input-daterange').datepicker({
            format: 'yyyy-mm-dd',
            startDate: '2025-01-01',
            language: "zh-CN",
            autoclose: true
        });
        // 从URL参数恢复筛选状态
        const urlParams = new URLSearchParams(window.location.search);
        $('[name="emergency_level"]').val(urlParams.get('emergency_level') || '');
        $('[name="status"]').val(urlParams.get('status') || '');
        $('[name="search"]').val(urlParams.get('search') || '');
        $('[name="start_date"]').val(urlParams.get('start_date') || '');
        $('[name="end_date"]').val(urlParams.get('end_date') || '');

    });
        // 选择工作人员
        function selectWorker(cardElement) {
            // 移除所有卡片的选中状态
            document.querySelectorAll('.worker-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.fa-check-circle').classList.add('text-muted');
                card.querySelector('.fa-check-circle').classList.remove('text-success');
            });

            // 添加当前卡片的选中状态
            cardElement.classList.add('selected');
            cardElement.querySelector('.fa-check-circle').classList.remove('text-muted');
            cardElement.querySelector('.fa-check-circle').classList.add('text-success');

            // 设置选中的worker_id
            const workerId = cardElement.getAttribute('data-worker-id');
            document.getElementById('selectedWorkerId').value = workerId;

            // 启用提交按钮
            document.getElementById('submitBtn').disabled = false;
        }

        // 表单提交处理
        $('#workerForm').submit(function(e) {
            e.preventDefault();

            const workerId = $('#selectedWorkerId').val();
            if (!workerId) {
                alert('请选择工作人员');
                return;
            }
            const date = $('#repair_date').val()
            console.log(date)
            if (!date){
                alert('请设置维修时间');
                return;
            }

            // 发送AJAX请求
            $.ajax({
                url: window.location.href,
                method: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        alert('工作人员添加成功！');
                        {#window.location.href = `/repairOrder_info/?{{params}}`;#}
                    } else {
                        alert('添加失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('发生错误: ' + error);
                }
            });
        });
    </script>
{% endblock %}
</body>
</html>